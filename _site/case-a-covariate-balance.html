<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Case Study A: Assessing treatment balance on covariates</title>

<script src="site_libs/header-attrs-2.13/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/lumen.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Purposeful Plotting</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
    Home
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fa fa-chart-line"></span>
     
    Case Studies
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="case-a-covariate-balance.html">Case A: Covariate Balance</a>
    </li>
    <li>
      <a href="case-b-event-study.html">Case B: Event Studies</a>
    </li>
    <li>
      <a href="case-c-spatial-clustering.html">Case C: Spatial Clustering</a>
    </li>
    <li>
      <a href="case-d-multiple-contrasts.html">Case D: Multiple Contrasts</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fa fa-info"></span>
     
    Resources
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="resources-ggplot.html">ggplot</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Case Study A: Assessing treatment balance on covariates</h1>

</div>


<p><br></p>
<div id="introduction-about-matching-methods" class="section level2">
<h2>Introduction about matching methods</h2>
<p>This data visualization case study comes from the increasingly prevalent world of matching based methods for statistical inference using observational data. This vignette will provide some context about why such two-stage design-analysis methods are increasingly common, but folks interested in the nitty gritty should check out the many great resources for learning more about matching and weighting that other folks have created.</p>
<p>Propensity score matching (PSM) is the classical matching method for causal inference with observational data, predicated on the idea that we can approximate experimental conditions by matching treated cases (i.e. who did in fact receive a treatment of some form) to one or more control cases based on some set of pre-treatment covariates relevant to selection into the treatment. While the classical method still is frequently used, there are currently many different matching algorithms that can be used in place for identifying suitable control cases to match to treated ones.</p>
<p>Similarly, there are related classes of methods based on weighting and subclassification that aim to recompose an observed population such that the treated and control groups have like characteristics on observed characteristics relevant to a given treatment. These methods differ in some important ways from matching methods (e.g., in their potential use of the entirety of the starting observational data), but their end game is similar: construct the weighted data such that the treated and control groups are similar on pre-treatment values, then assess how post-treatment values differ. As such, we will refer to matching methods as encompassing these other related approaches to adjusting observational data for causal inference.</p>
<p><br></p>
<div id="motivation-why-does-balance-matter" class="section level3">
<h3>Motivation: why does balance matter?</h3>
<p>For many years now, folks have used these methods to study effects of different treatments using observational data. This is because they <em>can</em> offer desirable properties (read: they don’t necessarily <em>have</em> to though).</p>
<p><a href="https://dx.doi.org/10.1214%2F09-STS313">Stuart (2010)</a> says the following on this matter (emphasis added):</p>
<blockquote>
<p>Alternatives to matching methods include adjusting for background variables in a regression model, instrumental variables, structural equation modeling, or selection models. Matching methods have a few key advantages over those other approaches. <strong>First</strong>, matching methods should not be seen in conflict with regression adjustment and in fact the two methods are complementary and best used in combination. <strong>Second</strong>, matching methods highlight areas of the covariate distribution where there is not sufficient overlap between the treatment and control groups, such that the resulting treatment effect estimates would rely heavily on extrapolation. Selection models and regression models have been shown to perform poorly in situations where there is insufficient overlap, but their standard diagnostics do not involve checking this overlap (Dehejia and Wahba, 1999, 2002; Glazerman et al., 2003). Matching methods in part serve to make researchers aware of the quality of resulting inferences. <strong>Third</strong>, matching methods have straightforward diagnostics by which their performance can be assessed.</p>
</blockquote>
<p>Based on this description, we can see that a key benefit of these methods is that matching can avoid problems that arise when treated and control groups differ severely on one or more covariates (a problem that users of regression adjustment might not be sensitive to). Observed data typically start in an <em>imbalanced</em> state between <em>treated</em> and <em>control</em> groups, where observed values may differ to a significant degree (i.e. on a t-test). The ultimate goal of any matching or weighting is then to induce <em>covariate balance</em> with the chosen matching-based method.</p>
<p>Despite these motivations being pretty clear (including diagnostics being one of the three), many papers have failed to document the extent to which their matching or weighting method is having the desired effect. Accordingly, there has been a longstanding call from methodologists about giving greater attention to whether these methods have mitigated concerns about confounding-on-observables sufficiently.</p>
<p>The classical methods are expected to induce balance as sample size grows to infinity, but frequently we have small data where residual balance can remain a problem after matching or weighting. In especially imbalanced data, matching and weighting can even be worse than regression adjustment (e.g., by giving extreme weight to cases whose covariate combination is exceptionally rare). And while new methods like entropy balancing provide even more desirable properties than classical methods, such approaches can still sometimes fail to induce the necessary balance on these covariates and so we need to document whether they are satisfactory.</p>
<p>Bottom line: just check for balance, ok?</p>
<p><br></p>
</div>
<div id="a-graphical-solution-or-how-i-learned-to-love-the-love-plot" class="section level3">
<h3><em>A Graphical Solution or: How I Learned to Love the Love Plot</em></h3>
<p>The solution to this problem turns out to be pretty straightforward. Calculate statistics for balance before and after matching/weighting, and just use those to show the reader what is going on with respect to the covariate distribution of the treated and control cases before and after any matching-based methods</p>
<p>For binary treatments, the statistic of interest is typically a <em>standardized mean difference</em>.</p>
<p><span class="math display">\[ SMD = \frac{\mu_{treat} - \mu_{control}}{SD_{pooled}} \]</span></p>
<p>Since we are most concerned with magnitudes of difference and not sign, it is common to look at <em>absolute standardized mean differences</em> as an alternative. We are then concerned with whether there are relatively large differences between the treated and control cases along the covariates of interest, with absolute values of SMD &gt; .10 conventionally taken to be too large of a difference. This is not a hard and fast rule, much like with alpha levels in the context of hypothesis testing, so for all intents and purposes the best case is that treatment and control groups have as similar of mean levels on covariates as possible.</p>
<p>While a table can certainly work for this sort of information (and beats nothing!), this is a case where a data visualization can actually be more intuitive for the sort of comparisons and takeaways we want readers to draw from this diagnostic information.</p>
<p><br></p>
</div>
<div id="visualizing-balance-statistics" class="section level3">
<h3>Visualizing balance statistics</h3>
<p>Enter: <em>the Love plot</em>. Credited to an author, Thomas E. Love, from <a href="https://doi.org/10.1093/eurheartj/ehi890">Ahmed et al. (2006)</a>, the following figure from that article presents absolute standardized mean differences (in terms of % of SD) as a plot based on points denoting each covariate’s pre- and post-match value.</p>
<center>
<div class="figure">
<img src="https://oup.silverchair-cdn.com/oup/backfile/Content_public/Journal/eurheartj/27/12/10.1093/eurheartj/ehi890/2/ehi89001.gif?Expires=1652796924&amp;Signature=NKj6k2Yr4Lsjupf1syr~HV3NKOFk1SXhegBDy~uQj2aYKoL~mOlHJwSOYCTLb31UE5Ddv6rFFN-aNBSwWAWVWdXx4aFKUcw9vq46d86noCR9dopTMwGrd~fcHMSqma9aqmlJSWk5qsxj9cGJCym92q6xJ9Ies-6GBGlFJ3J348bSqvArcXZdvol0Jrp8YqNXLqrpMMcmoNW1JjVP3NuMyVJzD8sdloGz0gpI8DuPtn7959KMxuMDElY-payXZzjKWnWEd3uu0fZIWLDhXpFHvr3oXB67Gox-c-vowiFdcxobG9i1NBNBXclV5FfGsuZwTtFuuRxSleae79oa5LiMSQ__&amp;Key-Pair-Id=APKAIE5G5CRDK6RD3PGA" alt="" />
<p class="caption">image</p>
</div>
</center>
<p><br></p>
<blockquote>
<p>Ahmed, A., Husain, A., Love, T. E., Gambassi, G., Dell’Italia, L. J., Francis, G. S., … &amp; Bourge, R. C. (2006). Heart failure, chronic diuretic use, and increase in mortality and hospitalization: an observational study using propensity score methods. European heart journal, 27(12), 1431-1439.</p>
</blockquote>
<p><br></p>
</div>
<div id="why-is-the-love-plot-better-than-a-table-or-some-other-type-of-figure" class="section level3">
<h3>Why is the Love plot better than a table, or some other type of figure?</h3>
<p>To avoid burying the lede, this is an effective visualization because <em>it leverages how the mind perceives the shapes (or in fancy terms, graphical primatives) within the plot to convey an overall takeaway.</em> It is obvious from looking at the plot that the pre-match and post-match covariate balances differ, and we can see that the post-match SMDs are all quite small.</p>
<p>Gestalt psychology offers some useful concepts for describing <em>why</em> exactly those conclusions are obvious. <a href="https://doi-org.proxy.library.cornell.edu/10.1109/IV.2002.1028859">Nesbitt and Friedrich (2002)</a> outline how so-called Gestalt “Laws” (read: principles) map onto how readers tend to interpret a given data visualization. In the spirit of this being a case study in data visualization (rather than matching methods), we’re going to talk about these Gestalt principles throughout the construction of our own Love plot since they inform generalized guidelines about how to present quantitative information.</p>
<p><br></p>
</div>
</div>
<div id="setup" class="section level2">
<h2>Setup</h2>
<div id="software-dependencies" class="section level3">
<h3>Software dependencies</h3>
<p>We need to do some housekeeping before we will be ready for making our own plots. We’ll start by loading the necessary software libraries for this vignette.</p>
<pre class="r"><code>library(tidyverse)    #ggplot2, dplyr, forcats
library(cobalt)       #bal.tab</code></pre>
<p><br></p>
</div>
<div id="data" class="section level3">
<h3>Data</h3>
<p>We’re going to use the data that was used in the following <a href="https://doi.org/10.1016/j.jeconom.2009.09.023">Cattaneo (2010)</a> paper focused on the effect of maternal smoking on child low birth weight status.</p>
<blockquote>
<p>Cattaneo, M. D. (2010). Efficient semiparametric estimation of multi-valued treatment effects under ignorability. Journal of Econometrics, 155(2), 138-154.</p>
</blockquote>
<pre class="r"><code>#load the data
cattaneo &lt;- haven::read_dta(&quot;./data/cattaneo2.dta&quot;)

#this will come in handy later
cattaneo_labels &lt;- cattaneo %&gt;% map_chr(~attributes(.)$label)

#now remove the labels
cattaneo &lt;- haven::zap_labels(cattaneo)

#here&#39;s what it looks like
glimpse(cattaneo)</code></pre>
<pre><code>## Rows: 4,642
## Columns: 23
## $ bweight    &lt;dbl&gt; 3459, 3260, 3572, 2948, 2410, 3147, 3799, 3629, 2835, 3880,…
## $ mmarried   &lt;dbl&gt; 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 0,…
## $ mhisp      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
## $ fhisp      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
## $ foreign    &lt;dbl&gt; 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
## $ alcohol    &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
## $ deadkids   &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1,…
## $ mage       &lt;dbl&gt; 24, 20, 22, 26, 20, 27, 27, 24, 21, 30, 26, 20, 34, 21, 23,…
## $ medu       &lt;dbl&gt; 14, 10, 9, 12, 12, 12, 12, 12, 12, 15, 12, 12, 14, 8, 12, 1…
## $ fage       &lt;dbl&gt; 28, 0, 30, 30, 21, 40, 29, 33, 24, 33, 31, 22, 29, 26, 27, …
## $ fedu       &lt;dbl&gt; 16, 0, 9, 12, 14, 12, 14, 12, 9, 15, 14, 12, 14, 8, 12, 11,…
## $ nprenatal  &lt;dbl&gt; 10, 6, 10, 10, 12, 9, 16, 11, 20, 9, 14, 5, 13, 8, 4, 10, 1…
## $ monthslb   &lt;dbl&gt; 30, 42, 17, 34, 0, 0, 29, 0, 0, 27, 0, 0, 26, 0, 0, 21, 33,…
## $ order      &lt;dbl&gt; 2, 3, 3, 2, 1, 1, 3, 1, 1, 2, 1, 1, 2, 1, 1, 2, 2, 5, 2, 3,…
## $ msmoke     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 2,…
## $ mbsmoke    &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1,…
## $ mrace      &lt;dbl&gt; 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 0,…
## $ frace      &lt;dbl&gt; 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 0,…
## $ prenatal   &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 2,…
## $ birthmonth &lt;dbl&gt; 12, 7, 3, 1, 3, 4, 12, 6, 6, 12, 8, 3, 9, 8, 11, 10, 7, 8, …
## $ lbweight   &lt;dbl&gt; 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0,…
## $ fbaby      &lt;dbl&gt; 0, 0, 0, 0, 1, 1, 0, 1, 1, 0, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0,…
## $ prenatal1  &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0,…</code></pre>
<p><br></p>
</div>
<div id="treatment-variable" class="section level3">
<h3>Treatment variable</h3>
<p>For the purpose of simplification, we’ll rely on the binary treatment indicator for whether the mother ever smoked during pregnancy, <code>mbsmoke</code>, though there is a frequency based measure too that looks at different levels of exposure among those who smoked.</p>
<pre class="r"><code>#here&#39;s our treatment measure
table(cattaneo$mbsmoke, useNA = &quot;always&quot;)</code></pre>
<pre><code>## 
##    0    1 &lt;NA&gt; 
## 3778  864    0</code></pre>
<p><br></p>
</div>
</div>
<div id="your" class="section level2">
<h2>Your 🥇 ❤️ 📈</h2>
<p>Ok, let’s get started with doing some visualization for ourselves. We are going to start by looking at the balance of the treatment and control groups across all of the covariates in the <code>cattaneo</code> data. Using every covariate is not a theoretically-driven decision, so in practice some consideration needs to be given to whether this is appropriate.</p>
<p>We can use the <code>cobalt</code> library’s <code>bal.tab()</code> function to obtain balance statistics (i.e., SMDs) for a set of covariates. The first implied argument is a data frame, and the second argument <code>treat</code> is a vector indicating the treatment of each row within the covariate data frame.</p>
<p><em>NB:</em> Instead of creating a new separate data frame to pass as the first argument, we instead just use a small pipe within the <code>bal.tab()</code> call to <code>select()</code> the covariate columns using ranges specified by <code>:</code>.</p>
<pre class="r"><code>#pass this to cobalt&#39;s bal.tab for quick estimation of SMDs
obs_balance &lt;- bal.tab(cattaneo %&gt;% select(mmarried:order, mrace:prenatal), 
                       treat = cattaneo$mbsmoke)</code></pre>
<pre><code>## Note: &#39;s.d.denom&#39; not specified; assuming pooled.</code></pre>
<p><br></p>
<p>Let’s first inspect by printing to console.</p>
<pre class="r"><code>#it&#39;s a list with a print method for console output
obs_balance</code></pre>
<pre><code>## Balance Measures
##              Type Diff.Un
## mmarried   Binary -0.2781
## mhisp      Binary -0.0120
## fhisp      Binary -0.0043
## foreign    Binary -0.0344
## alcohol    Binary  0.0726
## deadkids   Binary  0.0724
## mage      Contin. -0.3002
## medu      Contin. -0.5474
## fage      Contin. -0.3089
## fedu      Contin. -0.5183
## nprenatal Contin. -0.2838
## monthslb  Contin.  0.1842
## order     Contin.  0.1545
## mrace      Binary -0.0388
## frace      Binary -0.0711
## prenatal  Contin.  0.2340
## 
## Sample sizes
##     Control Treated
## All    3778     864</code></pre>
<p><br></p>
<p>We need to process the resulting object into something that we can plot with <code>ggplot()</code>, so we’ll inspect what’s in the <code>obs_balance</code> list and then wrangle the results into a data frame that fits the 1 row:1 geometry paradigm of <code>ggplot()</code>.</p>
<p>FYI, <code>love.plot()</code> is a pretty good default plot method provided by <code>cobalt</code> that you can use with <code>bal.tab</code> list objects, but since we want to dig into making plots of our own we’re going to bypass this route.</p>
<pre class="r"><code>#there are multiple elements to the bal.tab object
ls(obs_balance)</code></pre>
<pre><code>## [1] &quot;Balance&quot;      &quot;Observations&quot;</code></pre>
<pre class="r"><code>#but the Balance element is what we&#39;ll need for plotting
obs_balance &lt;- obs_balance$Balance
obs_balance$var &lt;- rownames(obs_balance)
obs_balance &lt;- obs_balance %&gt;% 
  select(var, type = Type, smd = Diff.Un) %&gt;%
  as_tibble() %&gt;%
  mutate(data = &quot;Unweighted&quot;)

#inspect what we&#39;ll actually plot
glimpse(obs_balance)</code></pre>
<pre><code>## Rows: 16
## Columns: 4
## $ var  &lt;chr&gt; &quot;mmarried&quot;, &quot;mhisp&quot;, &quot;fhisp&quot;, &quot;foreign&quot;, &quot;alcohol&quot;, &quot;deadkids&quot;, &quot;…
## $ type &lt;chr&gt; &quot;Binary&quot;, &quot;Binary&quot;, &quot;Binary&quot;, &quot;Binary&quot;, &quot;Binary&quot;, &quot;Binary&quot;, &quot;Cont…
## $ smd  &lt;dbl&gt; -0.27807617, -0.01195702, -0.00428590, -0.03435705, 0.07264217, 0…
## $ data &lt;chr&gt; &quot;Unweighted&quot;, &quot;Unweighted&quot;, &quot;Unweighted&quot;, &quot;Unweighted&quot;, &quot;Unweight…</code></pre>
<p><br></p>
<p>Let’s now make a first plot (we’ll keep things simple in case you are new to ggplot). In case you are unfamiliar, ggplot() expects a data frame (or equivalent) object as its first argument, and an aesthetic function (i.e., <code>aes()</code>) as its second argument. You don’t have to abide by this, but the main instance where not following this convention is advantageous is if you have several different data frames to plot at once.</p>
<pre class="r"><code>ggplot(obs_balance, aes(x = smd, y = var))</code></pre>
<p><img src="case-a-covariate-balance_files/figure-html/unnamed-chunk-7-1.png" width="672" style="display: block; margin: auto;" /></p>
<p><br></p>
<p>Then, after defining a first ggplot function with the aforementioned arguments, the key is to define the geometries that we’d like rows of our input data frame to correspond to. Here we use <code>geom_point()</code> to plot each <code>x</code> and <code>y</code> combination in our data frame <code>obs_balance</code> as a point.</p>
<pre class="r"><code>ggplot(obs_balance, aes(x = smd, y = var)) +
  geom_point()</code></pre>
<p><img src="case-a-covariate-balance_files/figure-html/unnamed-chunk-8-1.png" width="672" style="display: block; margin: auto;" /></p>
<p><br></p>
<div id="diagonalizing-for-familiarity" class="section level3">
<h3>Diagonalizing for familiarity</h3>
<p>By default, R will order character variables like <code>var</code> alphabetically. This is understandable but generally terrible for visualizations.</p>
<p>Sorting the covariates in terms of increasing or decreasing magnitude is thus essential to making the order of the y-axis values more coherent. We are going to call this <em>diagonalizing</em> the data to make the takeaway of interest more obvious.</p>
<pre class="r"><code>ggplot(obs_balance, aes(x = smd, y = fct_reorder(var, smd))) +
  geom_point() </code></pre>
<p><img src="case-a-covariate-balance_files/figure-html/unnamed-chunk-9-1.png" width="672" style="display: block; margin: auto;" /></p>
<p><br></p>
<p>This brings us to the first principle of interest, <em>the Law of Familiarity</em> which says that, <em>“Things are more likely to form groups if the groups appear familiar or meaningful.”</em></p>
<p>In the context of the Love plot, this means that the mind is more naturally inclined to connect the dots from the underling points we plotted. Before we sorted the y-axis, the underlying pattern was quite chaotic, making it hard to see any broader trend beyond a single value (i.e. this is not a line form we are familiar with).</p>
<p>Once we sorted the y-axis, though, it becomes more obvious which covariates have the most extreme starting imbalance—just look to the top and bottom entries on the y-axis.</p>
<p><img src="case-a-covariate-balance_files/figure-html/unnamed-chunk-10-1.png" width="672" style="display: block; margin: auto;" /></p>
<p><br></p>
</div>
<div id="annotating-to-manipulate-proximity" class="section level3">
<h3>Annotating to manipulate proximity</h3>
<p>We can still do a few more things to make this plot as interprettable as possible for readers.</p>
<p>Since a common convention is to assess SMD based on whether they are greater than a threshold value, we can make that easier for our reader to see that by using vertical lines created by <code>geom_vline()</code> at the common cutpoints of -.1 and .1.</p>
<p>Once we add these vertical rules to the plot, we disrupt (but don’t totally stop) the brain’s tendency to see a single uninterrupted line. Instead, the plot becomes defined by groups according to the three plot regions—covariates with negative imbalance, covariates with acceptable balance and covariates with positive imbalance.</p>
<pre class="r"><code>ggplot(obs_balance, aes(x = smd, y = fct_reorder(var, smd))) +
  geom_point() +
  geom_vline(xintercept = .10) +
  geom_vline(xintercept = -.10)</code></pre>
<p><img src="case-a-covariate-balance_files/figure-html/unnamed-chunk-11-1.png" width="672" style="display: block; margin: auto;" /></p>
<p><br></p>
<p>This brings us to another principle from Gestalt psychology, <em>the Law of Proximity</em> which says that, “Things that are near to each other appear to be grouped together.” By adding the vertical lines, we alter which things seem near to each other, and by extension, what we tend to group together as meaningful as a result.</p>
<p>We can illustrate this idea with an even simpler version of this idea is in the context of dividing absolute standardized differences into greater than or equal to /below .1 regions.</p>
<p><img src="case-a-covariate-balance_files/figure-html/unnamed-chunk-12-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This brings us to a good point at which to pause since we’ve explored the interesting aspects of a Love plot visualizing only the observed balance.</p>
<p>We can and will finesse the plot further, but since these are more minor details we will move to incorporating a comparison set of estimates that reflect the balance induced by a chosen matching-based method.</p>
<p><br></p>
</div>
</div>
<div id="incorporating-adjusted-balance-statistics" class="section level2">
<h2>Incorporating adjusted balance statistics</h2>
<p>Now let’s say we are interested in using <em>inverse probability of treatment weighting</em> (IPTW) as our design stage.</p>
<p>This method shares many similarities with propensity score matching (PSM), but instead of selecting some subset of matched cases (as with PSM), we assign each case a weight based on its estimated probability of experiencing the treatment category it received, conditional on covariates we decide are relevant for selection.</p>
<p>The intention is that the IPTW reweight our observed data such that the folks who did not actually receive the treatment (maternal smoking) are more similar in covariate composition to the folks who did.</p>
<p>To create the IPTW, we first estimate a logistic regression model predicting treatment conditional on covariates.</p>
<pre class="r"><code>#Hi, I&#39;m the design stage model
ps_model &lt;- glm(mbsmoke ~ mmarried + mhisp + fhisp + foreign + alcohol + deadkids + 
                  mage + medu + fage + fedu + nprenatal + monthslb + order + mrace + 
                  frace + prenatal,
                data = cattaneo,
                family = &quot;binomial&quot;)</code></pre>
<p><br></p>
<p>We then use this model to predict the probability of exposure and compute weights based on the inverse of the predicted probability of exposure (in the case of treated cases) or the inverse of 1 minus the predicted probability of exposure (in the case of control cases). Hence the name, <em>inverse probability of treatment</em> weighting.</p>
<pre class="r"><code>#estimate treatment probability
cattaneo$ps_score &lt;- predict(ps_model, type = &quot;response&quot;)

#construct propensity score weight
cattaneo$ipt_weight &lt;- ifelse(cattaneo$mbsmoke == 1,        #if treated
                              1/cattaneo$ps_score,          #do one over PS
                              1/(1-cattaneo$ps_score))      #else, do one over 1 minus PS</code></pre>
<p><br></p>
<p>Following this manual weight estimation, we can pass <code>bal.tab()</code> a new weights argument so that the function will give us adjusted balance statistics in return.</p>
<pre class="r"><code>ipt_balance &lt;- bal.tab(cattaneo %&gt;% select(mmarried:order, mrace:prenatal), 
                       treat = cattaneo$mbsmoke, 
                       weights = cattaneo$ipt_weight)</code></pre>
<pre><code>## Note: &#39;s.d.denom&#39; not specified; assuming pooled.</code></pre>
<pre class="r"><code>ipt_balance &lt;- ipt_balance$Balance
ipt_balance$var &lt;- rownames(ipt_balance)
ipt_balance &lt;- ipt_balance %&gt;% 
  select(var, type = Type, smd = Diff.Adj) %&gt;%
  as_tibble() %&gt;%
  mutate(data = &quot;IPT Weighted&quot;)

balance_stats &lt;- bind_rows(obs_balance, ipt_balance) </code></pre>
<p><br></p>
<p>We can now use our assembled balance statistics to create a full-fledged Love plot that shows how accounting for each case’s treatment propensity induces pretty good (but not perfect) balance along the selected covariates.</p>
<pre class="r"><code>ggplot(balance_stats, aes(x = abs(smd), y = fct_reorder(var, abs(smd)), shape = data)) +
  geom_point() +
  geom_vline(xintercept = .10) </code></pre>
<p><img src="case-a-covariate-balance_files/figure-html/unnamed-chunk-16-1.png" width="672" style="display: block; margin: auto;" /></p>
<p><br></p>
</div>
<div id="getting-the-labels-right" class="section level2">
<h2>Getting the labels right</h2>
<p>If we are going to use a graphic in a formal capacity as a paper figure, a next crucial step is to ensure that the labels are intuitive.</p>
<p>In many cases, this might mean manually creating a dictionary for linking covariate column names to meaningful labels. Thankfully, these data come with a shortcut since they are from Stata and have labels to begin with.</p>
<pre class="r"><code>#first make a data frame that we can join to the balance_stats df by var
label_dict &lt;- data.frame(var = names(cattaneo_labels),
                         label = as.character(cattaneo_labels))

#make the join
balance_stats &lt;- left_join(balance_stats, label_dict)</code></pre>
<pre><code>## Joining, by = &quot;var&quot;</code></pre>
<pre class="r"><code>#show the result
glimpse(balance_stats)</code></pre>
<pre><code>## Rows: 32
## Columns: 5
## $ var   &lt;chr&gt; &quot;mmarried&quot;, &quot;mhisp&quot;, &quot;fhisp&quot;, &quot;foreign&quot;, &quot;alcohol&quot;, &quot;deadkids&quot;, …
## $ type  &lt;chr&gt; &quot;Binary&quot;, &quot;Binary&quot;, &quot;Binary&quot;, &quot;Binary&quot;, &quot;Binary&quot;, &quot;Binary&quot;, &quot;Con…
## $ smd   &lt;dbl&gt; -0.278076167, -0.011957017, -0.004285900, -0.034357048, 0.072642…
## $ data  &lt;chr&gt; &quot;Unweighted&quot;, &quot;Unweighted&quot;, &quot;Unweighted&quot;, &quot;Unweighted&quot;, &quot;Unweigh…
## $ label &lt;chr&gt; &quot;1 if mother married&quot;, &quot;1 if mother hispanic&quot;, &quot;1 if father hisp…</code></pre>
<pre class="r"><code>#visualize label, rather than var now
ggplot(balance_stats, aes(x = abs(smd), y = fct_reorder(label, abs(smd)), 
                          shape = data)) +
  geom_point() +
  geom_vline(xintercept = .10) +
  labs(x = &quot;\nAbsolute Standardized Difference&quot;, y = &quot;&quot;, shape = &quot;&quot;)</code></pre>
<p><img src="case-a-covariate-balance_files/figure-html/unnamed-chunk-17-1.png" width="672" style="display: block; margin: auto;" /></p>
<p><br></p>
</div>
<div id="our-final-cosmetic-adjustments" class="section level2">
<h2>Our final cosmetic adjustments</h2>
<p>For the last bit of ggploting for this case study, we will make some minor adjustments aimed at increasing the interpretability of the plot in ways beyond its organization.</p>
<p>If plot organization is the workhorse kosher salt of data visualization (work with me here), but these final tweaks are the, um, often important finishing salt of graphical displays (nailed it).</p>
<p>Here the main adjustments are to:</p>
<ol style="list-style-type: decimal">
<li>increase the point geometry size</li>
<li>make the pre-weighting series hollow squares and the post-weighting series solid circles</li>
<li>apply a theme that uses less ink / color where unnecessary</li>
<li>move the legend to the bottom</li>
<li>remove some of the panel gridding</li>
</ol>
<pre class="r"><code>ggplot(balance_stats, aes(x = abs(smd), y = fct_reorder(label, abs(smd)), 
                          shape = data)) +
  geom_point(size = 2.5) +
  geom_vline(xintercept = .10) +
  scale_shape_manual(values = c(16, 22)) +
  labs(x = &quot;\nAbsolute Standardized Difference&quot;, y = &quot;&quot;, shape = &quot;&quot;) +
  theme_bw() +
  theme(legend.position = &quot;bottom&quot;,
        panel.grid.minor = element_blank())</code></pre>
<p><img src="case-a-covariate-balance_files/figure-html/unnamed-chunk-18-1.png" width="672" style="display: block; margin: auto;" /></p>
<p><br></p>
<p>We can see from our finalized Love plot that there are still absolute standardized differences greater than .1 — this is OK for the purposes of learning about data visualization since we’re not doing this analysis for real. If we were doing this for real, it’d be a good time consider including higher-order terms for some covariates, or alternative weighting algorithms like entropy balancing.</p>
<p><br></p>
</div>
<div id="takeaways" class="section level2">
<h2>Takeaways</h2>
<ol style="list-style-type: decimal">
<li>Love plots rock.</li>
<li>We should think about familiarity and proximity when designing data visualizations like Love plots</li>
<li>The basic idea of using point plots (rather than e.g., bar charts) with threshold lines extends to other contexts, including those where we incorporate estimates of uncertainty–regression coefficients, average marginal effects, etc.</li>
</ol>
<p><br></p>
</div>
<div id="hands-on-activity-create-a-love-plot-for-the-lalonde-data-set-used-in-many-ps-methods-papers-or-other-demo-ps-data-of-your-choice" class="section level2">
<h2>Hands-on activity: Create a Love plot for the <code>lalonde</code> data set (used in many PS methods papers) or other demo PS data of your choice</h2>
<p>Here the treatment is a job training program, with the outcome of interest being real earnings in 1978 (<code>re78</code>). The data are not balanced between treatment and control groups along the included covariates, so you should feel welcome to try using a matching method to construct weights or form a subsample that has greater balance along the covariates.</p>
<pre class="r"><code>lalonde &lt;- read_csv(&quot;https://raw.githubusercontent.com/robjellis/lalonde/master/lalonde_data.csv&quot;)</code></pre>
<pre><code>## Rows: 614 Columns: 11
## ── Column specification ────────────────────────────────────────────────────────
## Delimiter: &quot;,&quot;
## chr  (1): ID
## dbl (10): treat, age, educ, black, hispan, married, nodegree, re74, re75, re78
## 
## ℹ Use `spec()` to retrieve the full column specification for this data.
## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
<pre class="r"><code>glimpse(lalonde)</code></pre>
<pre><code>## Rows: 614
## Columns: 11
## $ ID       &lt;chr&gt; &quot;NSW1&quot;, &quot;NSW2&quot;, &quot;NSW3&quot;, &quot;NSW4&quot;, &quot;NSW5&quot;, &quot;NSW6&quot;, &quot;NSW7&quot;, &quot;NSW8…
## $ treat    &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
## $ age      &lt;dbl&gt; 37, 22, 30, 27, 33, 22, 23, 32, 22, 33, 19, 21, 18, 27, 17, 1…
## $ educ     &lt;dbl&gt; 11, 9, 12, 11, 8, 9, 12, 11, 16, 12, 9, 13, 8, 10, 7, 10, 13,…
## $ black    &lt;dbl&gt; 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
## $ hispan   &lt;dbl&gt; 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ married  &lt;dbl&gt; 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0…
## $ nodegree &lt;dbl&gt; 1, 1, 0, 1, 1, 1, 0, 1, 0, 0, 1, 0, 1, 1, 1, 1, 0, 1, 0, 0, 1…
## $ re74     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ re75     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ re78     &lt;dbl&gt; 9930.0460, 3595.8940, 24909.4500, 7506.1460, 289.7899, 4056.4…</code></pre>
<p><br></p>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
