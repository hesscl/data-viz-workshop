<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Case C: Understanding spatial distribution</title>

<script src="site_libs/header-attrs-2.13/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/lumen.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Purposeful Plotting</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
    Home
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fa fa-chart-line"></span>
     
    Case Studies
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="case-a-covariate-balance.html">Case A: Covariate Balance</a>
    </li>
    <li>
      <a href="case-b-event-study.html">Case B: Event Studies</a>
    </li>
    <li>
      <a href="case-c-spatial-distribution.html">Case C: Spatial Distribution</a>
    </li>
    <li>
      <a href="case-d-multiple-contrasts.html">Case D: Multiple Contrasts</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fa fa-info"></span>
     
    Resources
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="resources-ggplot.html">ggplot</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Case C: Understanding spatial distribution</h1>

</div>


<p><br></p>
<p>This case study focuses on using graphics to convey information about spatial distribution of one or more variables.</p>
<p>Most of the examples are going to be using choropleth maps, or visualizations of areal geographic units are shaded different hues to convey the units’ levels on a variable. These could be adminsitrative units like census tracts, or standardized units like square or hex cells for raster data.</p>
<p>We will talk a bit about visualizing point data a little just to give some examples, but the reason for focusing on choropleths more than other spatial data visualizations is because often the degree of simplication offered by the choropleth map strikes the right balance between how much information we covey and how much ink we use.</p>
<p>They are also one of those types of visualizations that everybody and there mother has seen before, like bar and line charts, and this ubiquity is relevant to its utility and currency for the purpose of visualizing spatial distribution that we’re exploring in this case study.</p>
<p><br></p>
<div id="motvation-how-can-we-investigate-and-convey-spatial-clustering" class="section level3">
<h3>Motvation: how can we investigate and convey spatial clustering</h3>
<p>Chorpleth maps aren’t guaranteed to be effective though, and so this is a case where being thoughtful about how the plot is constructed is salient to defining whether or not readers glean the takeaway that’s intended.</p>
<p>How we use color, labels and small multiples are all potentially relevant to whether or not we can convey data trends that may involve multiple variables or contrasts between subgroups.</p>
<p><br></p>
</div>
<div id="where-were-going" class="section level3">
<h3>Where we’re going</h3>
<p>We’ll go through a number of examples focused around three use cases:</p>
<ol style="list-style-type: decimal">
<li>basic maps for exploration where we don’t need polish</li>
<li>cleaned up maps for displaying a single variable’s spatial distribution</li>
<li>cleaned up maps for displaying two variables’ distribution</li>
</ol>
<p><br></p>
</div>
<div id="setup" class="section level2">
<h2>Setup</h2>
<div id="software-dependencies" class="section level3">
<h3>Software dependencies</h3>
<pre class="r"><code>library(tidyverse)   #dplyr, gggplot2
library(sf)          #spatial objects and functions for R
library(tigris)      #query tiger line data from Census
library(ggspatial)   #download basemaps
library(biscale)     #bivariate mapping
library(cowplot)     #dependency for biscale
library(ggpattern)   #needed for hatching choropleths</code></pre>
<p><br></p>
</div>
<div id="data" class="section level3">
<h3>Data</h3>
<div id="scraped-rental-listings" class="section level4">
<h4>Scraped rental listings</h4>
<p>The data for this case study come from a broader project aimed at scraping rental housing platforms across the United States. Given the nature of a topic like this, exploring and describing variations in these data across space are both salient goals.</p>
<pre class="r"><code>#load the listing extract for Seattle
listings &lt;- read_csv(&quot;./data/seattle-metro-listing-sample.csv&quot;)</code></pre>
<pre><code>## Rows: 65236 Columns: 8
## ── Column specification ────────────────────────────────────────────────────────
## Delimiter: &quot;,&quot;
## chr  (1): source
## dbl  (5): beds, rent, sqft, lat, lng
## lgl  (1): below_fmr
## date (1): date
## 
## ℹ Use `spec()` to retrieve the full column specification for this data.
## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
<pre class="r"><code>#inspect the table
glimpse(listings)</code></pre>
<pre><code>## Rows: 65,236
## Columns: 8
## $ source    &lt;chr&gt; &quot;Craigslist&quot;, &quot;Craigslist&quot;, &quot;Craigslist&quot;, &quot;Craigslist&quot;, &quot;Cra…
## $ date      &lt;date&gt; 2021-04-13, 2021-04-13, 2021-04-13, 2021-04-13, 2021-04-13,…
## $ beds      &lt;dbl&gt; 1, 1, 3, 1, 0, 1, 1, 3, 0, 1, 2, 1, 0, 1, 1, 1, 2, 0, 1, 2, …
## $ rent      &lt;dbl&gt; 1710, 1685, 3300, 1570, 1399, 1500, 455, 3995, 982, 1575, 29…
## $ sqft      &lt;dbl&gt; 910, 920, 1317, 900, 674, 235, NA, 1641, 188, 528, 885, 680,…
## $ lat       &lt;dbl&gt; 47.467, 47.467, 47.606, 47.467, 47.853, 47.669, 47.928, 47.6…
## $ lng       &lt;dbl&gt; -122.206, -122.206, -122.305, -122.206, -122.259, -122.100, …
## $ below_fmr &lt;lgl&gt; FALSE, FALSE, FALSE, TRUE, TRUE, TRUE, TRUE, FALSE, TRUE, TR…</code></pre>
<pre class="r"><code>#look at the source identifier
table(listings$source)</code></pre>
<pre><code>## 
## Craigslist GoSection8 
##      64272        964</code></pre>
<p><br></p>
<p>The CSV we load is flat tabular data that happens to contain spatial information. It is not already an sf, or <em>simple features</em> object, so we need to coerce it to be one in order for R to treat the data as having a spatial component.</p>
<p>Our data have latitude and longitude values according to a WGS 84 ellipsoid, so we use <code>st_as_sf()</code> for coercing our data to <code>sf</code> and then we use <code>st_set_crs()</code> to associate the coordinate reference system with the geometry.</p>
<pre class="r"><code>#coerce to sf, assign the starting coordinates CRS, transform to common mapping projection
listings &lt;- listings %&gt;%
  st_as_sf(coords = c(&quot;lng&quot;, &quot;lat&quot;), remove = FALSE) %&gt;%
  st_set_crs(&quot;EPSG:4326&quot;) %&gt;%
  st_transform(&quot;EPSG:32610&quot;) #UTM zone 10

#inspect the result
glimpse(listings)</code></pre>
<pre><code>## Rows: 65,236
## Columns: 9
## $ source    &lt;chr&gt; &quot;Craigslist&quot;, &quot;Craigslist&quot;, &quot;Craigslist&quot;, &quot;Craigslist&quot;, &quot;Cra…
## $ date      &lt;date&gt; 2021-04-13, 2021-04-13, 2021-04-13, 2021-04-13, 2021-04-13,…
## $ beds      &lt;dbl&gt; 1, 1, 3, 1, 0, 1, 1, 3, 0, 1, 2, 1, 0, 1, 1, 1, 2, 0, 1, 2, …
## $ rent      &lt;dbl&gt; 1710, 1685, 3300, 1570, 1399, 1500, 455, 3995, 982, 1575, 29…
## $ sqft      &lt;dbl&gt; 910, 920, 1317, 900, 674, 235, NA, 1641, 188, 528, 885, 680,…
## $ lat       &lt;dbl&gt; 47.467, 47.467, 47.606, 47.467, 47.853, 47.669, 47.928, 47.6…
## $ lng       &lt;dbl&gt; -122.206, -122.206, -122.305, -122.206, -122.259, -122.100, …
## $ below_fmr &lt;lgl&gt; FALSE, FALSE, FALSE, TRUE, TRUE, TRUE, TRUE, FALSE, TRUE, TR…
## $ geometry  &lt;POINT [m]&gt; POINT (559836.2 5257368), POINT (559836.2 5257368), PO…</code></pre>
<pre class="r"><code>#plot a subset of the geometry to get a sense of what this column captures
plot(listings$geometry[1:1000])</code></pre>
<p><img src="case-c-spatial-distribution_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<p><br></p>
</div>
<div id="tract-polygons" class="section level4">
<h4>Tract polygons</h4>
<p>The <code>tigris</code> library is a valuable resource if you need TIGER line based spatial data for units like census tracts.</p>
<p>One benefit to NHGIS shapefiles historically has been that they prefilter area that is just water from data like the census tract data we are obtaining for Washington State. As long as we use <code>erase_water()</code> from <code>tigris</code>, though, we’ll get to more or less the same place.</p>
<pre class="r"><code>#query spatial data, trim columns, filter to Seattle, project to listings&#39; CRS, erase water
tract &lt;- tracts(state = &quot;WA&quot;, cb = FALSE) %&gt;%
  select(STATEFP, COUNTYFP, TRACTCE, GEOID, geometry) %&gt;%
  filter(COUNTYFP %in% c(&quot;033&quot;, &quot;053&quot;, &quot;061&quot;)) %&gt;%
  st_transform(st_crs(listings)) %&gt;%
  erase_water(area_threshold = .90)</code></pre>
<p><br></p>
<p>We can then do a spatial intersection of our listing point data with the tract polygon data in order to append identifiers we can use for small area (i.e. census tract) summaries.</p>
<pre class="r"><code>#point in polygon intersection of listing data with tract shapefile
listings &lt;- st_join(listings, tract) </code></pre>
<p><br></p>
<p>Now we’ll use a slightly long pipe to assemble a <code>sf</code> with tract summaries of the Craigslist and GoSection8 listing samples. I’ve exploded the pipe a little bit to add notes</p>
<pre class="r"><code>#this pipe makes tract summaries of the listing data
tract_sum &lt;- listings %&gt;%
  
  #dplyr assumes we want to aggregate the geometry too if its present, so drop the point geometry
  st_drop_geometry() %&gt;%
  
  #group by tract and source, summarize the number of listings we scraped and the median rent
  group_by(GEOID, source) %&gt;%
  summarize(n = n(),
            med_rent = median(rent, na.rm = TRUE)) %&gt;%
  ungroup() %&gt;%
  
  #now do a little manipulation so we can pivot wider by source
  mutate(source = ifelse(source == &quot;Craigslist&quot;, &quot;cl&quot;, &quot;gos8&quot;),
         med_rent = ifelse(n &lt; 5, NA, med_rent)) %&gt;%
  pivot_wider(id_cols = GEOID, names_from = source, values_from = c(n, med_rent)) %&gt;%
  
  #then join the _tract_ geometry onto our working obj by tract ID
  left_join(tract, .) %&gt;%
  
  #finally, make a few modifications to the tract summary columns
  mutate_at(vars(starts_with(&quot;n&quot;)), ~ ifelse(is.na(.), 0, .))</code></pre>
<pre><code>## `summarise()` has grouped output by &#39;GEOID&#39;. You can override using the
## `.groups` argument.
## Joining, by = &quot;GEOID&quot;</code></pre>
<pre class="r"><code>#inspect the result
glimpse(tract_sum)</code></pre>
<pre><code>## Rows: 860
## Columns: 9
## $ STATEFP       &lt;chr&gt; &quot;53&quot;, &quot;53&quot;, &quot;53&quot;, &quot;53&quot;, &quot;53&quot;, &quot;53&quot;, &quot;53&quot;, &quot;53&quot;, &quot;53&quot;, &quot;5…
## $ COUNTYFP      &lt;chr&gt; &quot;053&quot;, &quot;053&quot;, &quot;053&quot;, &quot;053&quot;, &quot;053&quot;, &quot;033&quot;, &quot;033&quot;, &quot;033&quot;, …
## $ TRACTCE       &lt;chr&gt; &quot;072309&quot;, &quot;072311&quot;, &quot;072407&quot;, &quot;072408&quot;, &quot;072409&quot;, &quot;00530…
## $ GEOID         &lt;chr&gt; &quot;53053072309&quot;, &quot;53053072311&quot;, &quot;53053072407&quot;, &quot;5305307240…
## $ n_cl          &lt;dbl&gt; 262, 17, 114, 13, 0, 165, 7, 2, 4, 1, 9, 105, 9, 31, 20,…
## $ n_gos8        &lt;dbl&gt; 1, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 3, 0, 1, 0, 0, 1, 0, 0,…
## $ med_rent_cl   &lt;dbl&gt; 1539.5, 1375.0, 1697.0, 2200.0, NA, 1293.0, 3000.0, NA, …
## $ med_rent_gos8 &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ geometry      &lt;GEOMETRY [m]&gt; POLYGON ((533438.2 5232233,..., POLYGON ((53504…</code></pre>
<p><br></p>
</div>
</div>
</div>
<div id="exploratory-spatial-data-analysis-esda" class="section level2">
<h2>Exploratory spatial data analysis (ESDA)</h2>
<p>One of the most common uses of spatial data visualization in my experience is at the stage of data exploration. These graphics may be just for our own edification, but by plotting variables of interest spatially we can understand the extent to which there are interesting or even problematic degrees of spatial clustering. Whereas the interesting patterns might be revealed through exploring how novel measures are distributed across neighborhoods, problematic clustering would more in the realm of regression residual clustering across spatial units.</p>
<p>With spatial data in R, we can quickly write pipes to plot our data across space.</p>
<pre class="r"><code>tract_sum %&gt;%
  select(med_rent_cl) %&gt;%
  plot()</code></pre>
<p><img src="case-c-spatial-distribution_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<p>You can start fiddling with the graphic settings within <code>plot()</code> if you are a fan of <code>base</code> graphics:</p>
<pre class="r"><code>tract_sum %&gt;%
  select(med_rent_cl) %&gt;%
  plot(key.pos = 1, lwd = .1, main = &quot;I&#39;m a slightly more legible map of median rents&quot;)</code></pre>
<p><img src="case-c-spatial-distribution_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<p><br></p>
<div id="exploring-areal-data-using-ggplot" class="section level3">
<h3>Exploring areal data using <code>ggplot()</code></h3>
<p>But honestly, I find that for anything beyond the first sans-argument <code>plot()</code> map, it’s easier to just build out <code>ggplot()</code> code since I’m more familiar with the API.</p>
<p>As you can see from the map below, the default ggplot using <code>geom_sf()</code> leaves room for improvement. Some things are a bit unnecessary (grid, coordinate labels) and other things can just be finessed to a bit nicer form (legend, color usage). This means there are some mapping-specific customizations we’ll want to make, and thankfully nothing is really outside of normal ggplot helper functions you may already be aware of.</p>
<pre class="r"><code>ggplot(tract_sum, aes(fill = med_rent_cl)) +
  geom_sf()</code></pre>
<p><img src="case-c-spatial-distribution_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<p><br></p>
<p>Just removing or substantially reducing the boundary lines can be enough to make a figure useful enough for exploratory purposes in many cases. We can also make the <code>NA</code> value lighter so that our missing value cases are perceived as background to a greater degree.</p>
<pre class="r"><code>ggplot(tract_sum, aes(fill = med_rent_cl)) +
  geom_sf(color = NA) +
  scale_fill_continuous(na.value = &quot;gray80&quot;)</code></pre>
<p><img src="case-c-spatial-distribution_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<p><br></p>
</div>
<div id="exploring-point-data-using-ggplot" class="section level3">
<h3>Exploring point data using <code>ggplot()</code></h3>
<p>We can use point data with ggplot much the same. <code>geom_sf()</code> handles point and polygon data interchangeably.</p>
<pre class="r"><code>ggplot(listings, aes(color = source)) +
  geom_sf()</code></pre>
<p><img src="case-c-spatial-distribution_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<p><br></p>
<p>In this case, we can’t really discern much from the Craigslist points throughout much of the region since they overlap. We can improve this a little by making our points smaller, but a more sophisticated approach to summarizing point density would be to use 2D kernel density estimation or something akin to this.</p>
<pre class="r"><code>ggplot(listings, aes(color = source)) +
  geom_sf(size = .1)</code></pre>
<p><img src="case-c-spatial-distribution_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<p><br></p>
<p>We also may want a basemap for some of our investigative visualizations, particularly if the data are point geometries or an unfamiliar region.</p>
<p>R used to have an excellent library for this, <code>ggmap</code>, but due to changes in Google’s geocoding API over time it’s become a bit cumbersome to use, <em>especially</em> if you’re not going to be using the result for some finalized output. Thankfully, you can use <code>ggspatial</code>’s <code>annotation_map_tile()</code> to add an OpenStreetMaps basemap to a ggplot without much hassle.</p>
<pre class="r"><code>#plot the listings as small multiples according to source and with a basemap
ggplot(listings, aes(color = source)) +
  facet_grid(~ source) +
  annotation_map_tile(zoom = 9) +
  geom_sf(size = .05)</code></pre>
<p><img src="case-c-spatial-distribution_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<p><br></p>
</div>
</div>
<div id="single-variable-maps" class="section level2">
<h2>Single variable maps</h2>
<p>If you want to start polishing up something of interest, it can be useful to 1) tweak the scale, 2) remove unnecessary theme elements and 3) label the choropleth’s legend. You can go full cartographer and add a map scale and compass rose if you’d like, but YMMV in how essential this is at the publication stage. Ultimately, there’s no one size fits all approach and so this section is organized around guidelines for maps rather than hard and fast rules.</p>
<p>We’re going to build the map below because it is fairly clear in describing differences in the number of Craigslist ads that different neighborhoods in Seattle’s King County have. This is for demonstration purposes and so we are going to not try to adjust for how many ads we might expect, like what we’d want for a more serious analysis.</p>
<pre class="r"><code>#plot a tidied up map to show what we&#39;ll aim to produce
ggplot(tract_sum %&gt;% filter(COUNTYFP == &quot;033&quot;), aes(fill = log10(n_cl))) +
  geom_sf(color = NA) +
  scale_fill_viridis_b(breaks = 1:3, labels = 10^(1:3), na.value = &quot;gray80&quot;) +
  theme_void() +
  theme(legend.text = element_text(angle = 45, hjust = 1, vjust = 1),
        legend.position = &quot;bottom&quot;,
        legend.key.height = unit(.1, &quot;in&quot;),
        legend.key.width = unit(.5, &quot;in&quot;)) +
  labs(fill = &quot;N Craigslist Ads&quot;)</code></pre>
<p><img src="case-c-spatial-distribution_files/figure-html/unnamed-chunk-14-1.png" width="672" /></p>
<p><br></p>
<div id="guideline-1-consider-alternative-color-scales-and-transformations" class="section level3">
<h3>Guideline 1: consider alternative color scales and transformations</h3>
<p>One of the first things to consider with plotting choropleths is whether the scaling of the variable and the color palette are suitable for the task at hand.</p>
<p>In the case of trying to plot variables with strong skew, like in the present case with listing frequency by tract, you’re especially likely to find that default plotting options do not work well. Here, there are a handful tracts in Seattle and a few other areas with a very high number of ads due to the greater prevalence of multifamiliy housing in these areas.</p>
<pre class="r"><code>#this is not very useful
ggplot(tract_sum, aes(fill = n_cl)) +
  geom_sf(color = NA) </code></pre>
<p><img src="case-c-spatial-distribution_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<p><br></p>
<div id="divergent-palettes" class="section level4">
<h4>Divergent palettes</h4>
<p>Sometimes looking at a centered variable with a fill aesthetic that uses contrasting hues for positive and negative values (provided by <code>scale_fill_gradient2()</code>) can be useful for spotting clustering when doing this sort of investigation. In this case, we can see neighborhoods shaded purple and orange based on whether they are respectively above or below the median rent observed across the entire metro area.</p>
<p>This <em>divergent</em> color scaling is not super useful here, but exploring the data in this manner can help identify clustering of cases that are consistently above or below the average, or some other meaningful value.</p>
<pre class="r"><code>ggplot(tract_sum, aes(fill = med_rent_cl)) +
  geom_sf(color = NA) +
  scale_fill_gradient2(midpoint = median(listings$rent[listings$source == &quot;Craigslist&quot;], na.rm = TRUE))</code></pre>
<p><img src="case-c-spatial-distribution_files/figure-html/unnamed-chunk-16-1.png" width="672" /></p>
<p><br></p>
</div>
<div id="scale-transformations" class="section level4">
<h4>Scale transformations</h4>
<p>If you are trying to describe order of magnitude differences, a logarithmic transformation can be very useful. While logging by base <span class="math inline">\(e\)</span> is common in the context of regression, logging with base 10 (e.g., <code>log10()</code>) can sometimes be particularly intuitive for describing differences in magnitude in the contexxt of a visualization.</p>
<p>We lose the 0 value cases without doing anything else beyond the transformation (e.g., add one or some small amount to each case), but the result is a variable scaling where there are more discernable variations.</p>
<pre class="r"><code>ggplot(tract_sum, aes(fill = log10(n_cl))) +
  geom_sf(color = NA) +
  scale_fill_viridis_c(na.value = &quot;gray80&quot;)</code></pre>
<p><img src="case-c-spatial-distribution_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
<p><br></p>
</div>
<div id="binning-and-classification" class="section level4">
<h4>Binning and classification</h4>
<p>Furthermore, it can be very helpful to use binned or classified values to reduce the potential gradations in the color palette to a number that is more obviously discerned from each other (e.g., 4-6). If perceiving precise differences is the goal, then it is fairly essential to collapse continuous measures into some type of binned measure.</p>
<pre class="r"><code>ggplot(tract_sum, aes(fill = log10(n_cl))) +
  geom_sf(color = NA) +
  scale_fill_viridis_b(na.value = &quot;gray80&quot;) </code></pre>
<p><img src="case-c-spatial-distribution_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<p><br></p>
<p>There are other ways to incorporate jenks (natural), quantile and equal interval breaks using the <code>classInt</code> library. The general idea is to use functions from this library to generate new classified variables that can then be visualized with <code>scale_fill_discrete()</code>, <code>scale_fill_brewer()</code> or <code>scale_vill_viridis_d()</code>.</p>
<p><br></p>
</div>
</div>
<div id="guideline-2-label-your-legend-appropriately" class="section level3">
<h3>Guideline 2: label your legend appropriately</h3>
<p>We can make the legend labels a little clearer than what ggplot provides by default through mapping exponentiated values to the labels that are used in the legend. It helps to set the <code>breaks</code> and <code>labels</code> in a manner like the following since ggplot will throw errors if these arguemnt values aren’t the same length.</p>
<pre class="r"><code>ggplot(tract_sum, aes(fill = log10(n_cl))) +
  geom_sf(color = NA) +
  scale_fill_viridis_b(breaks = 1:3, labels = 10^(1:3), na.value = &quot;gray80&quot;) </code></pre>
<p><img src="case-c-spatial-distribution_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
<p><br></p>
</div>
<div id="guideline-3-remove-mapping-elements-that-use-ink-but-contribute-little-information-to-the-empirical-narrative" class="section level3">
<h3>Guideline 3: remove mapping elements that use ink but contribute little information to the empirical narrative</h3>
<pre class="r"><code>ggplot(tract_sum, aes(fill = log10(n_cl))) +
  geom_sf(color = NA) +
  scale_fill_viridis_b(breaks = 1:3, labels = 10^(1:3), na.value = &quot;gray80&quot;) +
  theme_bw()</code></pre>
<p><img src="case-c-spatial-distribution_files/figure-html/unnamed-chunk-20-1.png" width="672" /></p>
<p><br></p>
</div>
<div id="a-sometimes-guideline-4-only-bite-off-as-much-as-you-can-chew-or-take-it-easy-on-your-readers-eyes" class="section level3">
<h3>(A Sometimes) Guideline 4: only bite off as much as you can chew (or: take it easy on your readers eyes)</h3>
<p>The more limited your space is or the small your data’s geographic units are, the more you ought to try to filter to views that may be more digestible so that each unit can be a meaningful size.</p>
<pre class="r"><code>ggplot(tract_sum, aes(fill = log10(n_cl))) +
  geom_sf(color = NA) +
  scale_fill_viridis_b(breaks = 1:3, labels = 10^(1:3), na.value = &quot;gray80&quot;) +
  theme_void() +
  theme(legend.text = element_text(angle = 45, hjust = 1, vjust = 1),
        legend.position = &quot;bottom&quot;,
        legend.key.height = unit(.1, &quot;in&quot;),
        legend.key.width = unit(.5, &quot;in&quot;)) +
  labs(fill = &quot;Craigslist N&quot;)</code></pre>
<p><img src="case-c-spatial-distribution_files/figure-html/unnamed-chunk-21-1.png" width="672" /></p>
<p><br></p>
<p>Sometimes showing a subset of the broader study region can provide a more interpretable density of information within the map. Then the other area that is omitted in this figure can be displayed in other figures, whether they are provided in the main text or as supplement.</p>
<pre class="r"><code>ggplot(tract_sum %&gt;% filter(COUNTYFP == &quot;033&quot;), 
       aes(fill = log10(n_cl))) +
  geom_sf(color = NA) +
  scale_fill_viridis_b(breaks = 1:3, labels = 10^(1:3), na.value = &quot;gray80&quot;) +
  theme_void() +
  theme(legend.text = element_text(angle = 45, hjust = 1, vjust = 1),
        legend.position = &quot;bottom&quot;,
        legend.key.height = unit(.1, &quot;in&quot;),
        legend.key.width = unit(.5, &quot;in&quot;)) +
  labs(fill = &quot;Craigslist N&quot;)</code></pre>
<p><img src="case-c-spatial-distribution_files/figure-html/unnamed-chunk-22-1.png" width="672" /></p>
<p><br></p>
</div>
</div>
<div id="bivariate-maps" class="section level2">
<h2>Bivariate maps</h2>
<p>Sometimes it can be very useful to visualize two variables simultaneously. By using the <code>biscale</code> library, this task is made relatively straightforward compared to assembling such a map by hand.</p>
<pre class="r"><code>#prep bivariate map data
bi_classes &lt;- bi_class(tract_sum %&gt;% filter(COUNTYFP == &quot;033&quot;), 
                       x = n_cl, y = n_gos8, style = &quot;jenks&quot;, dim = 3)

#prep bivariate map legend using the provided function
bi_legend &lt;- bi_legend(pal = &quot;GrPink&quot;, dim = 3, size = ,
                      xlab = &quot;N Craigslist&quot;, ylab = &quot;N GoSection8&quot;)

#generate bivariate map 
bi_map &lt;- ggplot(bi_classes, aes(fill = bi_class)) +
  geom_sf(show.legend = FALSE, color = NA) +
  bi_scale_fill(pal = &quot;GrPink&quot;, dim = 3) +
  bi_theme()

#print map by itself
bi_map</code></pre>
<p><img src="case-c-spatial-distribution_files/figure-html/unnamed-chunk-23-1.png" width="672" /></p>
<pre class="r"><code>#add legend
ggdraw() +
  draw_plot(bi_map, 0, 0, 1, 1) +
  draw_plot(bi_legend, 0.65, .15, 0.25, 0.25)</code></pre>
<p><img src="case-c-spatial-distribution_files/figure-html/unnamed-chunk-23-2.png" width="672" /></p>
<p><br></p>
<p>Given the prior points about choosing colors wisely, there are a couple options. Using <code>ggpattern</code>, it’s possible to construct a bivariate map that uses hatching for one of the colors so that it is accessible to readers viewing in a grayscale format still. Takes a lot more effort, but the end result passes inspection when viewed as grayscale.</p>
<pre class="r"><code>#make the data we&#39;ll use for plotting
bi_classes &lt;- tract_sum %&gt;%
  filter(COUNTYFP == &quot;033&quot;) %&gt;%
  bi_class(x = n_cl, y = n_gos8, 
           style = &quot;jenks&quot;, dim = 3) %&gt;%
  mutate(bi_class_1 = str_split_fixed(bi_class, &quot;-&quot;, n = 2)[,1],
         bi_class_2 = str_split_fixed(bi_class, &quot;-&quot;, n = 2)[,2])

#make the map                  
bi_map &lt;- ggplot() +
  geom_sf(data = bi_classes,  aes(fill = bi_class_1), color = &quot;gray80&quot;, lwd = .2, show.legend = FALSE) +
  geom_sf_pattern(data = bi_classes %&gt;% filter(bi_class_2 %in% c(&quot;2&quot;, &quot;3&quot;)) %&gt;%
                    group_by(bi_class_2) %&gt;% summarize(), 
                  aes(pattern_type = bi_class_2),
                  pattern = &quot;magick&quot;, alpha = 1.0, 
                  pattern_fill = &quot;black&quot;, color = NA, fill = NA) +
  scale_fill_manual(values = c(&quot;white&quot;, RColorBrewer::brewer.pal(7, &quot;Greens&quot;)[c(3, 5)])) + 
  scale_pattern_type_discrete(choices = c(&quot;right45&quot;, &quot;crosshatch45&quot;)) +
  labs(x = &quot;&quot;, y = &quot;&quot;) +
  guides(fill = &quot;none&quot;, pattern_type = &quot;none&quot;) +
  theme_void() +
  theme(plot.title = element_text(hjust = 0.5))

#construct the legend from scatch
leg_grid &lt;- expand_grid(x = 1:3, y = 1:3)
leg_grid &lt;- dplyr::mutate(leg_grid, x = as.factor(x), y = as.factor(y))

bi_legend &lt;- ggplot2::ggplot() + 
  geom_tile(data = leg_grid, 
                    mapping = aes(x = x, y = y, fill = x),
                    color = NA) +
  geom_tile_pattern(data = leg_grid %&gt;% filter(y %in% c(&quot;2&quot;, &quot;3&quot;)), 
                    mapping = aes(x = x, y = y, pattern_type = y),
                    pattern = &quot;magick&quot;, alpha = 1.0, pattern_scale = 1,
                    pattern_fill = &quot;black&quot;, color = NA, fill = NA) + 
  ggplot2::labs(x = substitute(paste(&quot;N Craigslist&quot;,&quot;&quot; %-&gt;% &quot;&quot;)), 
                y = substitute(paste(&quot;N GoSection8&quot;, &quot;&quot; %-&gt;% &quot;&quot;))) + 
  scale_fill_manual(values = c(&quot;white&quot;, RColorBrewer::brewer.pal(7, &quot;Greens&quot;)[c(3, 5)])) + 
  scale_pattern_type_discrete(choices = c(&quot;right45&quot;, &quot;crosshatch45&quot;)) +
  bi_theme() + 
  ggplot2::theme(axis.title = ggplot2::element_text(size = 10)) + 
  ggplot2::coord_fixed() +
  guides(fill = &quot;none&quot;, pattern_type = &quot;none&quot;)

#make the plot using both plots
ggdraw() +
  draw_plot(bi_map, 0, 0, 1, 1) +
  draw_plot(bi_legend, 0.65, 0.15, 0.35, 0.35)</code></pre>
<p><img src="case-c-spatial-distribution_files/figure-html/unnamed-chunk-24-1.png" width="672" /></p>
<p><br></p>
</div>
<div id="hands-on-use-the-austin-data-or-your-own-data-to-make-graphics-for-trends-over-time." class="section level2">
<h2>Hands-on: Use the <code>austin</code> data or your own data to make graphics for trends over time.</h2>
<pre class="r"><code>#load a similar extract of data based on Austin metro area listings
austin &lt;- read_csv(&quot;./data/austin-metro-listing-sample.csv&quot;)</code></pre>
<pre><code>## Rows: 27398 Columns: 8
## ── Column specification ────────────────────────────────────────────────────────
## Delimiter: &quot;,&quot;
## chr  (1): source
## dbl  (5): beds, rent, sqft, lat, lng
## lgl  (1): below_fmr
## date (1): date
## 
## ℹ Use `spec()` to retrieve the full column specification for this data.
## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
<pre class="r"><code>#take a look
glimpse(austin)</code></pre>
<pre><code>## Rows: 27,398
## Columns: 8
## $ source    &lt;chr&gt; &quot;Zillow&quot;, &quot;Zillow&quot;, &quot;Zillow&quot;, &quot;Zillow&quot;, &quot;Zillow&quot;, &quot;Zillow&quot;, …
## $ date      &lt;date&gt; 2021-04-09, 2021-04-09, 2021-04-09, 2021-04-09, 2021-04-09,…
## $ beds      &lt;dbl&gt; 3, 3, 2, 4, 3, 3, 5, 3, 3, 3, 3, 4, 3, 3, 4, 3, 2, 2, 4, 3, …
## $ rent      &lt;dbl&gt; 1720, 1700, 957, 1439, 1850, 1565, 2395, 1550, 1495, 1500, 1…
## $ sqft      &lt;dbl&gt; 1665, 1330, 850, 1456, 2140, 1359, 2168, 1051, 1100, 1200, 1…
## $ lat       &lt;dbl&gt; 29.836, 29.977, 29.893, 29.920, 29.950, 29.971, 29.820, 29.8…
## $ lng       &lt;dbl&gt; -97.933, -97.841, -97.916, -97.889, -97.845, -97.843, -97.93…
## $ below_fmr &lt;lgl&gt; FALSE, FALSE, TRUE, TRUE, FALSE, FALSE, FALSE, FALSE, FALSE,…</code></pre>
<p><br></p>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
